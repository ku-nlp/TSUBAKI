###################################
# 検索エンジン基盤 TSUBAKI README #
###################################

2012/05/25 Daisuke Kawahara <dk@i.kyoto-u.ac.jp>


TSUBAKIは、科研特定領域研究「情報爆発」(2006年度〜2010年度)において、京
都大学黒橋・河原研究室が中心となって開発した検索エンジン基盤です。その
特徴は、構文・格解析、同義語・句のマッチングなど深い言語解析技術に基づ
く検索です。1CPUあたり100万文書程度の検索が可能で、複数CPUの並列化によ
り大規模文書集合の検索に対応しています。現在、日本語文書と英語文書の検
索が可能です。

以下の説明では、1CPU(localhostのみ)で検索を行うことを想定しています。並
列化による100万件以上の文書の検索については、本README最後の注意事項をご
覧ください。


1. 準備
-------

* 必要なライブラリ、モジュールのインストール

- 必要なライブラリのインストール
  -- libxml (http://xmlsoft.org/)
  -- TinyCDB (http://www.corpit.ru/mjt/tinycdb.html)
  -- BerkeleyDB (http://www.oracle.com/technetwork/products/berkeleydb/)


- 必要なPerlモジュールのインストール (CPAN等を用いてインストール)
  -- Unicode::Japanese
  -- PerlIO::gzip
  -- XML::LibXML
  -- XML::Writer
  -- CDB_File
  -- BerkeleyDB
  -- MLDBM
  -- Text::Darts
  -- Error (Module::Metadata, version, Perl::OSType, Module::Buildも必要)

  ※ 本パッケージのcpanディレクトリに、上記のPerlモジュールのtarballを
     同梱していますので、必要に応じてご利用ください。


* 言語解析ツール・データベースのインストール

- 日本語の文書を検索する場合に必要なツール・データベースのインストール

  -- 日本語形態素解析システムJUMANのインストール
     http://nlp.ist.i.kyoto-u.ac.jp/index.php?JUMAN

  -- 日本語構文・格解析システムKNPのインストール
     http://nlp.ist.i.kyoto-u.ac.jp/index.php?KNP

     ※ JUMAN/KNPのPerlモジュールもインストールしてください。

  -- SynGraph日本語データベース(同義語・句の辞書)のダウンロード
     http://nlp.ist.i.kyoto-u.ac.jp/nl-resource/SynGraph/SynGraph-syndb.tar.bz2
     をダウンロードし、TSUBAKI直下(このディレクトリ)にて展開してください。
     データベースがSynGraph/syndb以下に展開されます。


- 英語の文書を検索する場合に必要なツールのインストール

  -- HPSG構文解析器Enjuのインストール
     http://www.nactem.ac.uk/enju/index.ja.html

  ※ 英語の同義語・句のデータを別途用意すれば、SynGraphデータベース形式
     に変換して使うことができます。詳細は、SynGraphのドキュメントをご覧
     ください。


* TSUBAKI設定ファイルの生成

以下では、このREADMEがあるディレクトリを $TSUBAKI_DIR と表します。

$TSUBAKI_DIRにおいて以下のように ./setup.shを実行することにより、検索対
象文書データの場所および解析ツールなどのインストール場所を含むTSUBAKIの
設定ファイルを自動生成します。

  例1) 日本語サンプル文書データを対象にする場合
       % ./setup.sh -d sample_doc/ja

  例2) 英語サンプル文書データを対象にする場合
       % ./setup.sh -e -d sample_doc/en

  ※ ./setup.shの重要なオプションの説明
       -d データパス             : インデックスなどのデータ出力場所を指定
       -s 検索対象文書パス       : 検索対象文書の場所を指定 (default: データパス/src_doc)
       -j                        : 日本語の文書を検索する場合 (default)
       -e                        : 英語の文書を検索する場合
       -c 出力設定ファイル名	 : 出力する設定ファイル名を指定 (default: $TSUBAKI_DIR/conf/configure)

以下では、上記の例1を実行し、日本語サンプル文書データを対象にしていると
して説明します。日本語サンプル文書データ以外を用いる場合に設定が必要な
箇所にはその旨を記述しています。


* 検索サーバプログラムのコンパイル

$TSUBAKI_DIRにおいて、make を実行してください。

  ※ コンパイルが失敗する場合は、$TSUBAKI_DIR/search/Makefileにおいて、
     CXXFLAGSとCDB_LIBをcdb.h、libcdb.aのインストール場所に応じて修正し
     てください。


2. TSUBAKI標準フォーマット変換
------------------------------

検索対象文書に言語解析を適用し、その解析結果をXML形式で出力します。以後、
このXML形式を「TSUBAKI標準フォーマット」と呼びます。$TSUBAKI_DIRにおいて
次のように実行してください。

  % make DATADIR=`pwd`/sample_doc/ja html2sf

  ※ DATADIRは絶対パスを指定してください。日本語サンプル文書データ以外
     を対象にする場合は、上記の設定で指定した文書データパスをDATADIRと
     して設定してください。


3. インデックス生成
-------------------

TSUBAKI標準フォーマットデータからインデックスを生成します。$TSUBAKI_DIR
において次のように実行してください。

  % make DATADIR=`pwd`/sample_doc/ja indexing

  ※ DATADIRは絶対パスを指定してください。日本語サンプル文書データ以外
     を対象にする場合は、上記の設定で指定した文書データパスをDATADIRと
     して設定してください。


4. 検索
-------

* 検索テスト

$TSUBAKI_DIRにおいて、"./search.sh -c conf/configure クエリ"
を実行して検索のテストをします。クエリはUTF-8で入力してください。

  例) % ./search.sh -c conf/configure 京大	→ hitcountが6になる
      % ./search.sh -c conf/configure 紅葉	→ hitcountが5になる


* ブラウザからの検索

ブラウザから検索するためには、localhostでsshdとhttpdが起動している必要
があります。次のようにして、sshdとhttpdが起動していることを確認してくだ
さい。

  % ps aux | grep sshd
  % ps aux | grep httpd

これらが起動していない場合は、システム設定を変更して起動してください。

検索サーバとスニペットサーバを次のようにして起動します。このスクリプト
の実行によって、localhostにsshし、これらのサーバを起動しています。

  % scripts/server-all.sh -c conf/configure start

  ※ サーバを止めるには、上記のstartをstopとして実行してください。

検索フロントエンド($TSUBAKI_DIR/cgi/index.cgi)にWebブラウザでアクセスし、
クエリを入力して検索を実行します。

  例) http://localhost/ が /var/www/html ディレクトリに対応している場合
      は、"ln -s `pwd` /var/www/html"を実行することによって、
      /var/www/html直下にTSUBAKIディレクトリへのシンボリックリンクをは
      ります。Webブラウザでhttp://localhost/TSUBAKI/cgi/index.cgi にア
      クセスします。

  ※ ブラウザでindex.cgiのソースコードが表示される場合は、httpdの設定で
     CGIが実行可能となっていることを確認してください (Apacheでは
     "Options ExecCGI"と"AddHandler cgi-script .cgi)。



■ 注意事項

・サンプル以外の文書セットに対して検索するためには、上記設定において
  ./setup.shに"-s 検索対象文書パス"を指定してください。検索対象文書の
  形式としては、現在のところHTMLのみに対応しています。

・複数の文書セットに対して検索するためには、上記設定において./setup.sh
  に"-c 出力設定ファイル名"を指定し、異なる名前の設定ファイルを生成して
  ください。

・100万件以上の文書を検索対象にするには、複数の検索サーバとスニペットサー
  バを起動する必要があります。このためには、設定ファイル(conf/configure)
  において、次のようにSEARCH_SERVERSとSNIPPET_SERVERSの行をサーバ台数分
  コピーし、サーバ名を記入してください。

  SEARCH_SERVERS	server01	39999	/somewhere/idx/0000	none
  SEARCH_SERVERS	server02	39999	/somewhere/idx/0001	none
  SNIPPET_SERVERS	server01	59001	0000
  SNIPPET_SERVERS	server02	59001	0001


■ ドキュメント

より詳細なドキュメントは、TSUBAKI Wikiを参照してください。

TSUBAKI Wiki: http://tsubaki-wiki.ixnlp.nii.ac.jp/index.php
              username: tsubaki-user
              password: tsu8k!

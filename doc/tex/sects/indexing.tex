\section{インデキシング}

\subsection{概要}

本節ではインデックスデータについて述べる．TSUBAKI では転置インデックス方
式を採用している．転置インデックスを100万文書単位で作成し，検索時にデータを
120並列に引くことで，1.2億ページを対象とした検索を実現している．

インデックスに登録されるタームの種類及び登録されるデータを表\ref{size}に
示す．タームは標準フォーマットに含まれる言語解析結果から抽出されるため，
インデキシングの時に改めて文書は解析しない．
%
また，近接検索（フレーズ検索を含む）および，スコア計算時にタームの出現位
置を利用するため，タームの出現位置をインデックスに登録している
\footnote{係り受けタームの出現位置は必要でないが，インデッ
クスへアクセスを統一的に扱うため，出現位置の情報をインデックスに書き出し
ている．}．出現位置は，文書の先頭か
ら数えて当該単語が何単語目かを意味する．
%



\begin{figure}[t]
\begin{center}
\includegraphics[height=\columnwidth,clip,angle=-90]{figs/index.eps}
\end{center}
\caption{インデックスデータのフォーマット}
\label{sample_index}
\end{figure}

\begin{figure}[t]
\begin{center}
\includegraphics[height=\columnwidth,clip,angle=-90]{figs/indexing-step.eps}
\end{center}
\caption{インデックス作成の流れ}
\label{sample_index}
\end{figure}

\begin{table}[t]
\begin{center}
\caption{インデックスデータに登録される情報}
\label{size}
\footnotesize
\begin{tabular}{l|c|c|c|c|c}
\hline
種類&文書頻度&出現文書ID&出現位置&頻度&タームの素性\\ \hline
単語（出現形）  & O & O & O & O & O \\
単語（代表表記）& O & O & O & O & O \\
係り受け（出現形）& O & O & O & O & O \\
係り受け（代表表記）& O & O & O & O & O \\
同義表現        & O & O & O & O & O \\ \hline
\end{tabular}
\end{center}
\end{table}

% 表\ref{size}に各インデックスデータに含まれる情報，足切りの有無，全体のファイルサイズを示す．表より同義表
% 現の係り受けインデックスのファイルサイズが大きいことがわかる．
% また，係り受けインデックスに比べ，単語インデックスの方がファイルサイズが
% 大きくなっているが，これは，単語インデックスが全単語の全出現
% 位置をインデックスとして登録しているのに対し，係り受け関係インデックスの
% 方は，自立語同士の係り受け関係に限定，さらに位置情報を保持していないためである．


インデックス作成の概要を図\ref{indexing-steop}にします．
作成の手順は以下の通りである．
% 配布ツールを用いた，より具体的な作
% 成手順については，本マニュアル末尾の付録を参照されたい．

\begin{description}
\item [Step 1:] ウェブ標準フォーマットデータからタームを抽出し，タームファ
	    イルを作成する
\item [Step 2:] 文書毎に作成されたタームファイルを100万文書単位にマージ
	    する
\item [Step 3:] タームファイルををバイナリ化する
\item [Step 4:] 文書頻度，タイトル，URLデータベースを構築する
\end{description}


% \subsection{インデックスの単位}
% 
% TSUBAKIでは，インデックスの単位として以下のものを採用している．
% 
% \begin{itemize}
% \item 単語（自立語，機能語全て）
% \item 自立語同士の係り受け関係
% \item 同義表現（単語，句）
% \item 同義表現同士の係り受け関係
% \end{itemize}
% 
% \noindent
% 単語および自立語同士の係り受け関係についてはKNPの解析結果から,同
% 義表現,同義表現同士の係り受け関係についてはSynGraph~\cite{syngraph}の解析結果か
% ら取得している．
% 
% 以下では各インデックスについて述べる．
% 



\subsection{タームファイルの作成}

\begin{figure}[t]
\centering
\begin{tabular}{|l|}\hline
\begin{minipage}{.8\columnwidth}
\begin{verbatim}
 :
s1178:銀幕 0181640135:2.97@2,19,24#46&0.99&16,191&0.99&256,227&0.99&64
s1196:楽しむ 0181640135:1.98@50,60#373&0.99&16,703&0.99&16
s1221:児童 0181640135:0.99@8#107&0.99&16
 :
ここ* 0181640135:1@15#160&1&16
こと* 0181640135:2@54,56#533&1&16,595&1&16
こども* 0181640135:1@8#107&1&16
こども*->用語* 0181640135:1@8#107&1&16
この 0181640135:1@62#749&1&16
この* 0181640135:1@62#749&1&16
 :
多->行 0181640135:1@19#198&1&256
子供 0181640135:1@8#107&1&16
子供->用語 0181640135:1@8#107&1&16
学 0181640135:1@8#109&1&16
学* 0181640135:1@8#109&1&16
学*->教材* 0181640135:1@8#109&1&16
 :
\end{verbatim}
\end{minipage}
\\ \hline
\end{tabular}
\caption{タームファイルの例}
\label{termfile}
\end{figure}

個々の標準フォーマットデータからタームを抽出し{\bf タームファイル}を作成
する．図\ref{termfile}にタームファイルの例を示す．タームファイルでは，見
出し順に従ってタームの情報が保存されている．見出しの末尾に付いている「＊」
はそのタームが出現形であることを表しており，フレーズ検索時に利用される．

\begin{figure}[t]
\small
\centering
\fbox{
\begin{minipage}{.75\columnwidth}
\begin{algorithmic}
\STATE $\mathbf{TERM\_FILE} \rightarrow \mathrm{TERM\_INFO}+$
\STATE $\mathbf{TERM\_INFO} \rightarrow \mathrm{LABEL}\ \ \ \mathrm{SID} : \mathrm{TOTAL\_FREQ}\ ＠\ \mathrm{SENT\_ID}+ \# \mathrm{POS\_DATA}+$
\STATE $\mathbf{POS\_DATA} \rightarrow \mathrm{POSITON}\ \&\ \mathrm{FREQ}\ \&\ \mathrm{FEATURE}$
\STATE $\mathbf{LABEL} \rightarrow \mathit{String}$
\STATE $\mathbf{SID} \rightarrow \mathit{String}$
\STATE $\mathbf{TOTAL\_FREQ} \rightarrow \mathit{Float}$
\STATE $\mathbf{SENT\_ID} \rightarrow \mathit{Integer}$
\STATE $\mathbf{POSITON} \rightarrow \mathit{Integer}$
\STATE $\mathbf{FREQ} \rightarrow \mathit{Float}$
\STATE $\mathbf{FEATURE} \rightarrow \mathit{Integer}$
\end{algorithmic}
\end{minipage}
}
\caption{タームファイルのフォーマット}
\label{termfile_format}
\end{figure}

タームファイルのフォーマットを図\ref{termfile_format}に示す．
%
{\rm LABEL}はタームの見出し，{\rm SID}はタームが抽出された文書ID(SID)，
{\rm TOTAL\_FREQ}はタームの出現頻度，{\rm SENT\_ID}はタームの出現している
文IDである．{\rm POS\_DATA}はタームの各出現に関する情報を保持するデータで
あり，出現位置({\rm POSITON})，頻度({\rm FREQ})，素性({\rm FEATURE})から
なる．
%
{\rm FREQ}が{\it Float}になっているのは，同義表現タームの場合，1未満の値
をとるためである．同義表現タームの場合，その頻度としてSYNGRAPHより与えら
れるスコアが用いられる．
%
{\rm FEATURE}とは，ブロックタイプなどのタームの各出現に対して付与される情
報である．{\rm FEATURE}は32ビット整数で実装されており，ビットに個々の素性
が発火しているかどうかの情報を持たせる．現状で導入されている素性を表
\ref{term_feature}に示す．例えば，{\rm FEATURE}の値が256(100000000)の場合，
当該タームがメインテキスト領域に出現していたことを意味する．

\begin{table}[t]
\centering
\small
\caption{ターム素性ビット}
\label{term_feature}
\begin{tabular}{c|c|l} \hline
\multicolumn{2}{c|}{ビット}&素性\\ \hline
下位 & 1 & ブロックタイプ(タイトル) \\ \cline{2-3}
↑   & 2 & ブロックタイプ(キーワード) \\\cline{2-3}
     & 3 & ブロックタイプ(ヘッダー) \\\cline{2-3}
     & 4 & ブロックタイプ(フッター) \\\cline{2-3}
     & 5 & ブロックタイプ(リンク) \\\cline{2-3}
     & 6 & ブロックタイプ(画像) \\\cline{2-3}
     & 7 & ブロックタイプ(フォーム) \\\cline{2-3}
↓   & 8 & ブロックタイプ(メインテキスト) \\\cline{2-3}
上位 & 9 & ブロックタイプ(未判定) \\ \hline
\end{tabular}
\end{table}

以下では，標準フォーマットデータから抽出されるタームについて述べる．


\subsubsection{単語ターム}

SYNGRAPHの解析結果から，単語の出現形，代表表記を単語タームとして抽出する．
単語の出現形はフレーズ検索時に利用する．また，代表表記は内容語のみ抽出す
る．JUMANの代表表記をタームとして抽出することで，「子供」「子ども」「こど
も」のような表記の揺れが解消され，検索漏れを軽減する効果が期待できる．
%
例えば，図\ref{knp_result}に示した文「子ども服をせんたくする」の言語
解析結果からは以下の語がタームとして抽出される．

\begin{figure}[t]
\begin{center}\includegraphics[height=0.3\columnwidth,clip,angle=-90]{figs/dpnd.eps}
\end{center}
\caption{「子ども服をせんたくする」をKNPで解析して得られる係り受け関係（代表表記化済み，下線が引かれている単語は内容語）}
\label{dpnd}
\end{figure}

\begin{description}
\item [単語ターム（出現形）:] 子ども，服，を，せんたく，する
\item [単語ターム（代表表記）:] 子供，服，選択，洗濯
\end{description}

\noindent
「せんたく」のように複数の代表表記（「洗濯」「選択」）が考えられる単語に
ついては，全ての表記が文書に出現したものと見なす．この時，各単語の出現頻
度は，代表表記の個数で割った値になる（つまり，「せんたく」が1回だけ現れる
文書では，「洗濯」および「選択」が0.5回ずつ出現していると見なされる．）


\subsubsection{係り受けターム}

言語解析結果から係り受け関係を抽出し，係り受けタームとしてインデックスに
登録する．
%
図~\ref{knp_result}に挙げた言語解析結果から得られる係り受け関係を図
\ref{dpnd}に示す．この結果からは抽出される係り受けタームを以下に示す．

\begin{description}
\item [係り受けターム（出現形）:] 子ども→服，服→せんたく
\item [係り受けターム（代表表記）:] 子供→服，服→洗濯，服→選択
\end{description}

\noindent
TSUBAKIでは，文節間ではなく内容語間の修飾関係（子供→服）を係り受け関係と
見なす．
%
単語タームと同様に，係り先または係り元に複数の代表表記がある場合は，その
全ての組み合わせを係り受けタームとして抽出し，その出現頻度は，組み合わせ
の数で割った値とする．


\subsubsection{同義表現ターム}

言語解析結果より語・句の同義表現を抽出し，それを同義表現タームとし
てインデックスに登録することで，より柔軟な検索を実現する．
%
同義表現タームを用いることで，クエリとして「乳児の虫歯を予防する」が与え
られた場合であっても，「乳児」が「赤ちゃん」と，「予防」が「防ぐ」と同義
関係にあることから，「赤ちゃんの虫歯を防ぐには...」と書かれた文書を検索す
ることが可能になる．

SYNGRAPHで解析することで得られるSYNノードを同義表現タームとして抽出する．
例えば，図\ref{syn_result}からは，以下の同義表現タームが抽出される．

\begin{flushleft}
\texttt{<}SYNID:乳児/にゅうじ\texttt{>}, \texttt{<}SYNID:s121:乳飲み子/ちのみご\texttt{>}, 
\texttt{<}SYNID:虫歯/むしば\texttt{>}, \texttt{<}SYNID:s15141:虫歯/むしば\texttt{>}, \texttt{<}SYNID:s15137:歯/は\texttt{>},
\texttt{<}SYNID:予防/よぼう\texttt{>}, \texttt{<}SYNID:s17557:予防/よぼう\texttt{>}, \texttt{<}SYNID:s4234:防ぐ/ふせぐ\texttt{>},
\texttt{<}SYNID:s35:回避/かいひ\texttt{>}
\end{flushleft}

\noindent
同義表現ターム抽出する際，SYNノードに付与されている以下の文法素性は削除す
る．

\begin{center}
\texttt{<可能>}，\texttt{<尊敬>}，\texttt{<受身>}，\texttt{<使役>}，
\texttt{<反義語>}，\texttt{<上位語>}
\end{center}

同義表現タームについては，SYNGRAPHより与えられるスコアを出現頻度と見なし，
インデックスに登録する．例えば，「赤ちゃん」に対して「\texttt{<ベビー>}」
というSYNノードが付与されるが，この時，この文書にはSYNノード「\texttt{<ベ
ビー>}」が0.99回出現しているものと考える．

また，複合語に対して1つのSYNノードが付与されることがある．例えば，「京都
大学」に対してはSYNノード「\texttt{<京大>}」が付与される．このような場合，
SYNノードの出現位置は，付与している複合語の主辞の出現位置とする．先程の
例の場合，SYNノード「京大」の出現位置は，「大学」の出現位置と同じになる．


\subsection{タームファイルのマージ}

標準フォーマットデータ毎に作成されたタームファイルをマージする．マージは
2段階に分けて行う．まず，タームファイルを1万件単位でまとめる．この操作は
メモリ上で行う．先述したようにTSUBAKIでは，100万文書単位でインデックスデー
タを作成・管理している．そのため，1万件毎にマージされたファイルを100件マー
ジし，100万件分のタームファイルを作成する．この操作はメモリ上では難しいた
めディスク上で行う．

\subsection{タームファイルのバイナリ化}

100万文書分のタームファイルを，図\ref{sample_index}に示したフォーマッ
トに従ってバイナリ化する．文書ID(SID)には改訂番号(--数字)が付与されている
ため，このままでは文字列データとして保存するしかない．そこでインデック
スに登録する各文書に対して内部的な整数値({\bf TSUBAKI ID})を付与するこ
とで整数データとして文書IDをインデックスに保存する．もともとの文書IDと
TSUBAKI IDの対応関係は別ファイル(sid2tid)に書き出して保存する．

図中の★素性マスク領域★は，高速にクエリの条件にマッチする文書を検索する
ために利用する．このビット列は，タームの各素性ビットをOR演算したものであ
る．例えば，タイトル領域(1)，メインテキスト領域(256)にタームが出現してい
た場合，257(100000001)が素性マスクとして保存される．

オフセット領域は，各文書におけるタームの位置頻度情報へのポインタである．
このオフセット値を参照することで，位置頻度情報へ直接アクセスすることが
可能である．

タームの出現位置及び頻度情報は32ビット整数で保持されており，下位10ビット
が頻度，上位22ビットが出現位置を表している．
%
同義表現タームの場合，出現頻度は1未満の値をとる．このような小数値を効率良
く保存するため，出現頻度を1000倍しその整数部分をインデックスに登録する．
出現頻度は最大で1であるため，頻度情報の保存には10ビット(1024)あれば十分で
ある．
%
また位置情報についても，$2^{22}$を越える位置は考えにくいため，上限を22ビッ
トとして問題ない．

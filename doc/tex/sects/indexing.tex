\section{インデキシング}

\subsection{概要}

本節ではインデックスデータについて述べる．TSUBAKI では転置インデックス方
式を採用している．転置インデックスデータを100文書単位で作成し，検索時にデー
タを120並列に引くことで，1.2億ページを対象とした検索を実現している．

インデックスデータに登録されるタームの種類及び登録されるデータを表
\ref{size}に示す．タームは標準フォーマットに含まれる言語解析結果から抽出
されるため，インデキシングの時に改めて文書を解析しない．
%
また，近接検索（フレーズ検索を含む）および，スコア計算時にタームの出現位
置を利用するため，全ターム（単語のみならず，同義表現タームおよび係り受け
ターム）の出現位置をインデックスデータに登録している．出現位置は，文書の
先頭から数えて当該単語が何単語目かを意味する．
%



\begin{figure}[t]
\begin{center}
\includegraphics[height=\columnwidth,clip,angle=-90]{figs/index.eps}
\end{center}
\caption{★インデックスのフォーマット}
\label{sample_index}
\end{figure}

\begin{table}[t]
\begin{center}
\caption{インデックスデータに登録される情報}
\label{size}
\footnotesize
\begin{tabular}{c|c|c|c|c|c}
\hline
種類&文書頻度&出現文書ID&出現位置&頻度&タームの素性\\ \hline
単語（表層形）  & O & O & O & O & O \\
単語（代表表記）& O & O & O & O & O \\
係り受け        & O & O & O & O & O \\
同義表現        & O & O & O & O & O \\ \hline
\end{tabular}
\end{center}
\end{table}

% 表\ref{size}に各インデックスデータに含まれる情報，足切りの有無，全体のファイルサイズを示す．表より同義表
% 現の係り受けインデックスのファイルサイズが大きいことがわかる．
% また，係り受けインデックスに比べ，単語インデックスの方がファイルサイズが
% 大きくなっているが，これは，単語インデックスが全単語の全出現
% 位置をインデックスとして登録しているのに対し，係り受け関係インデックスの
% 方は，自立語同士の係り受け関係に限定，さらに位置情報を保持していないためである．


以下に，インデックス作成の手順を示す．配布ツールを用いた，より具体的な作
成手順については，本マニュアル末尾の付録を参照されたい（★ステップを図示
する）

\begin{description}
\item [Step 1:] ウェブ標準フォーマットデータからタームを抽出し，タームファ
	    イルを作成する
\item [Step 2:] 文書毎に作成されたタームファイルを100万文書単位にマージ
	    する
\item [Step 3:] タームファイルををバイナリ化する
\item [Step 4:] 文書頻度，タイトル，URLデータベースを構築する
\end{description}


% \subsection{インデックスの単位}
% 
% TSUBAKIでは，インデックスの単位として以下のものを採用している．
% 
% \begin{itemize}
% \item 単語（自立語，機能語全て）
% \item 自立語同士の係り受け関係
% \item 同義表現（単語，句）
% \item 同義表現同士の係り受け関係
% \end{itemize}
% 
% \noindent
% 単語および自立語同士の係り受け関係についてはKNPの解析結果から,同
% 義表現,同義表現同士の係り受け関係についてはSynGraph~\cite{syngraph}の解析結果か
% ら取得している．
% 
% 以下では各インデックスについて述べる．
% 



\subsection{タームファイルの作成}

個々の標準フォーマットデータを入力として，各文書から抽出されたタームを保
存したタームファイルを作成する．図★にタームファイルの例を示す．以下では，
標準フォーマットデータから抽出されるタームについて述べる．★素性


\subsubsection{単語ターム}

SYNGRAPHの解析結果から，単語の出現形，代表表記を単語タームとして抽出する．
単語の出現形はフレーズ検索時に利用する．また，代表表記は内容語のみ抽出す
る．JUMANの代表表記をタームとして抽出することで，「子供」「子ども」「こど
も」のような表記の揺れが解消され，検索漏れを軽減する効果が期待できる．
%
例えば，図\ref{knp_result}に示した文「子ども服をせんたくする」の言語
解析結果からは以下の語がタームとして抽出される．

\begin{figure}[t]
\begin{center}\includegraphics[height=0.3\columnwidth,clip,angle=-90]{figs/dpnd.eps}
\end{center}
\caption{「子ども服をせんたくする」をKNPで解析して得られる係り受け関係（代表表記化済み，下線が引かれている単語は内容語）}
\label{dpnd}
\end{figure}

\begin{description}
\item [出現形:] 子ども，服，を，せんたく，する
\item [代表表記:] 子供，服，選択，洗濯
\end{description}

\noindent
「せんたく」のように複数の代表表記（「洗濯」「選択」）が考えられる単語に
ついては，全ての表記が文書に出現したものと見なす．この時，各単語の出現頻
度は，代表表記の個数で割った値になる（つまり，「せんたく」が1回だけ現れる
文書では，「洗濯」および「選択」が0.5回ずつ出現していると見なされる．）


\subsubsection{係り受けターム}

SYNGRAPHの解析結果から係り受け関係を抽出し，係り受けタームとしてインデッ
クスに登録する．
%
図~\ref{knp_result}に挙げた言語解析結果から得られる係り受け関係を図
\ref{dpnd}に示す．これより，以下の係り受けタームが抽出される．

\begin{description}
\item [係り受けターム:] 子供→服，服→洗濯，服→選択
\end{description}

\noindent
TSUBAKIでは，文節間ではなく内容語間の修飾関係（子供→服）を係り受け関係と
見なす．
%
単語タームと同様に，係り先または係り元に複数の代表表記がある場合は，その
全ての組み合わせを係り受けタームとして抽出し，その出現頻度は，組み合わせ
の数で割った値としている．


\subsubsection{同義表現ターム}

言語解析結果より語・句の同義表現を抽出し，それを同義表現タームとし
てインデックスに登録することで，より柔軟な検索を実現する．
%
同義表現タームを用いることで，クエリとして「乳児の虫歯を予防する」が与え
られた場合であっても，「乳児」が「赤ちゃん」と，「予防」が「防ぐ」と同義
関係にあることから，「赤ちゃんの虫歯を防ぐには...」と書かれた文書を検索す
ることが可能になる．

具体的には，言語解析結果のSYNGRAPHの解析結果の部分にあるSYNノードをター
ムとして抽出する．例えば，図\ref{syn_result}からは，以下の同義表現ターム
が抽出される．

\begin{flushleft}
\texttt{<}SYNID:乳児/にゅうじ\texttt{>}, \texttt{<}SYNID:s121:乳飲み子/ちのみご\texttt{>}, 
\texttt{<}SYNID:虫歯/むしば\texttt{>}, \texttt{<}SYNID:s15141:虫歯/むしば\texttt{>}, \texttt{<}SYNID:s15137:歯/は\texttt{>},
\texttt{<}SYNID:予防/よぼう\texttt{>}, \texttt{<}SYNID:s17557:予防/よぼう\texttt{>}, \texttt{<}SYNID:s4234:防ぐ/ふせぐ\texttt{>},
\texttt{<}SYNID:s35:回避/かいひ\texttt{>}
\end{flushleft}

\noindent
同義表現ターム抽出する際，SYNノードに付与されている以下の文法素性は削除す
る．

\begin{center}
\texttt{<可能>}，\texttt{<尊敬>}，\texttt{<受身>}，\texttt{<使役>}，
\texttt{<反義語>}，\texttt{<上位語>}
\end{center}

同義表現タームの出現頻度としては，SYNGRAPHより与えられるスコアを，そのター
ムの出現頻度と見なし，インデックスに登録する．例えば，「赤ちゃん」に対し
て「\texttt{<ベビー>}」というSYNノードが付与されるが，この時，この文書に
は，SYNノード「\texttt{<ベビー>}」が0.99回出現しているものと考える．

また，複合語に対して1つのSYNノードが付与されることがある．例えば，「京都
大学」に対してはSYNノード「\texttt{<京大>}」が付与される．このような場合，
SYNノードの出現位置は，付与している複合語の主辞の出現位置とする．先程の
例の場合，SYNノード「京大」の出現位置は，「大学」の出現位置となる．

\subsection{タームファイルのマージ}

標準フォーマットデータ毎に作成されたタームファイルをマージする．マージは
2段階に分けて行う．まず，タームファイルを1万件単位でまとめる．この操作は，
メモリ上で行う．先述したようにTSUBAKIでは，100万文書単位でインデックスデー
タを作成・管理している．そのため，1万件毎にマージされたファイルを100件マー
ジし，100万件分のタームファイルを作成する．この操作はメモリ上では難しいた
めディスク上で行う．

\subsection{タームファイルのバイナリ化}

★頻度10倍
★TSUBAKI ID

100万文書分のデータを含むタームファイルを，図\ref{format}に示したフォーマッ
トに従ってバイナリ化する．図中の★文書マスク領域★は，高速にクエリの条件
にマッチする文書を作成するために利用する．このビット列は，ターム素性ビッ
トをOR演算したものであり，このビット列を参照することで，文書が素性条件に
一致しているかどうかを高速に検出することができる．

また，オフセット領域は，各文書におけるタームの位置頻度情報へのポインタと
なっており，このオフセット値をみることで，位置頻度情報へ直接アクセスする
ことが可能である．

各タームの出現位置，頻度情報は，一つの32ビット整数で表現しており，下位10
ビットが頻度，上位22ビットが出現位置を表している．出現頻度は，各出現位置
毎に保持されるため，最大1であるため，10ビットあれば十分表現可能である．
また位置情報についても，$2^{22}$を越える位置は考えにくいため，22ビットで
問題ない．

